#!/usr/bin/env bash
set -e

message=""
branch=""

for arg in "$@"; do
  case "$arg" in
    --message=*|-m=*)
      message=${arg#*=}
      ;;
    --branch=*|-b=*)
      branch=${arg#*=}
      ;;
    *)
      echo "Unknown argument: $arg"
      exit 1
      ;;
  esac
done

# Determine the branch name
if [[ -z "$branch" ]]; then
  branch=$(git rev-parse --abbrev-ref HEAD)
fi

# Retrieve the pull request URL
pr_url=$(gh pr view "$branch" --json url -q .url 2>/dev/null)
if [[ -z "$pr_url" ]]; then
  echo "No pull request found for branch: $branch"
  exit 1
fi

# Watch CI status until it becomes SUCCESS
echo "Watching CI status for PR: $pr_url"
while true; do
  state=$(gh pr checks --json state -q '.[0].state')
  if [[ "$state" == "SUCCESS" ]]; then
    echo "$message $pr_url"
    exit 0
  elif [[ "$state" == "FAILURE" ]]; then
    echo "$pr_url"
    exit 1
  else
    echo "Current CI state: $state. Retrying in 60 seconds..."
    sleep 60
  fi
done
